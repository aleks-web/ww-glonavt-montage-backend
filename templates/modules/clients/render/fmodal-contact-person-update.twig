{#
    request_params - параметры запроса
    person - персона
    contacts_persons - контактные персоны
#}

{# Start Проверяем есть ли директор среди других контактных лиц #}
{% set has_director = false %}
{% for person in contacts_persons %}
    {% if person.is_director == 1 %}
        {% set has_director = true %}
    {% endif %}
{% endfor %}
{# End Проверяем есть ли директор среди других контактных лиц #}

<div id="fmodal-contact-person-update" class="fmodal fmodal-contact-person-update" style="display: none;">
    <div class="fmodal__title">Обноввление контактного лица</div>

        <div class="fmodal__content">

            <div class="fmodal__vertical">
                {% include 'components/input-text.twig' with {
                    settings: {
                        db_field_name: 'name',
                        required: true,
                        pls: 'Имя',
                        val: person.name
                    }
                } %}

                {% include 'components/input-text.twig' with {
                    settings: {
                        db_field_name: 'surname',
                        pls: 'Фамилия',
                        val: person.surname
                    }
                } %}

                {% include 'components/input-text.twig' with {
                    settings: {
                        db_field_name: 'patronymic',
                        pls: 'Отчество',
                        val: person.patronymic
                    }
                } %}

                {% include 'components/input-text.twig' with {
                    settings: {
                        db_field_name: 'post',
                        pls: 'Должность',
                        val: person.post
                    }
                } %}

                {% include 'components/input-date.twig' with {
                    settings: {
                        db_field_name: 'birth',
                        pls: 'Дата рождения',
                        val: person.birth
                    }
                } %}

                {% include 'components/input-text.twig' with {
                    settings: {
                        db_field_name: 'tel',
                        pls: 'Телефон',
                        val: person.tel
                    }
                } %}

                {% include 'components/input-text.twig' with {
                    settings: {
                        db_field_name: 'email',
                        pls: 'Почта',
                        val: person.email
                    }
                } %}

                {% include 'components/checkbox.twig' with {
                    settings: {
                        db_field_name: 'is_director',
                        label: 'Этот человек является руководителем',
                        checked: person.is_director,
                        disable: has_director
                    }
                } %}

            </div>
            
        </div>

        <div class="fmodal__control-btns">
            <button data-fancybox-close class="fmodal__btn btn-bad">Отменить</button>
            <button class="fmodal__btn btn-good js-submitter" onclick="tab_modal_update_contact_person({{ request_params.person_id }})">Сохранить</button>
        </div>

    </div>
</div>

<script>
    function tab_modal_update_contact_person(person_id) {
        let modal_wrapper_components = '#fmodal-contact-person-update';

        let update_url = API_V1_URLS.clients.update_contact_person; // API_V1_URLS - Смотрим в main.js
        let formData = cpns_get_formdata_by_wrapper(modal_wrapper_components);

        // Если есть заполненные поля и нет ошибок, отправляем запрос
        if (formData && !cpns_get_errors_by_wrapper(modal_wrapper_components)) {
            formData.append('id', person_id);

            // Отправка запроса
            $.ajax({
                url: update_url,
                method: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    console.log(response);
                    if (response.status == "success") {
                        push(response.message ? response.message : "Успешное обновление контактного лица", "success", 2000);
                        load_tab_contacts_persons({{ person.organization_id }}, true);
                        $.fancybox.close();
                        $('#fmodal-contact-person-wrapper').html('');
                    }
                    else {
                        console.log(response);
                    }
                },
            });
        }
    }
</script>